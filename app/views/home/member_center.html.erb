<% if Announcement.current.message.present? %>
  <div class="alert alert-warning text-center">
    <strong>Announcement:</strong> <%= Announcement.current.message %>
  </div>
<% end %>

<!-- Top Header -->
<div class="container-fluid bg-dark-gray-blue text-white py-3">
  <div class="default-padding-left">
    <h1 class="text-left font-primary-title"> Member Center | Welcome <%= @user.first_name %>! </h1>
  </div>
</div>


<!-- Main Body Split -->
<div class="container-fluid bg-gold py-2">
  <div class="row flex-grow-1">

    <!-- Left Column Containing Photo Gallery, Caption, Sign Out, Exec Buttons -->
    <div class="col-md-5 bg-legion-blue py-4 px-4">
    <div class="default-padding-left">

      <!-- Sign Out + Manage Gallery Buttons -->
      <div class="d-grid gap-3 mb-4">
        <%= button_to "Sign out", destroy_user_session_path,
          method: :delete,
          form: { "data-turbo": "false" },
          class: "btn white-btn-edit btn-lg w-100 font-primary-heading default-border-radius" %>

        <% if @user.exec? || @user.president? %>
          <%= link_to "Manage Gallery & Caption", "#",
            class: "btn white-btn-edit btn-lg w-100 font-primary-heading default-border-radius",
            data: { bs_toggle: "modal", bs_target: "#manageGalleryModal" } %>
        <% end %>
      </div>


        <!-- Photo Gallery Carousel -->
        <div id="memberPhotoCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
          <div class="carousel-inner">
            <% @shared_user.gallery_photos.each_with_index do |photo, index| %>
              <div class="carousel-item <%= 'active' if index == 0 %> text-center">
                <%= image_tag(url_for(photo.variant(resize_to_limit: [1600, 1600], sharpen: "0x1.5").processed),
                    class: "d-block mx-auto img-fluid shadow-sm", alt: "Gallery Photo") %>
              </div>
            <% end %>
          </div>

          <!-- PhotoCarousel Controls -->
          <button class="carousel-control-prev" type="button" data-bs-target="#memberPhotoCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#memberPhotoCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>

        <!-- Legion Photo Gallery Caption Container -->
        <div class="caption-container py-2 px-3 mb-3 text-center font-secondary-subheading">
          <%= member_center_caption_text %>
        </div>
      </div>
    </div>


    <!-- Right Column Containg Quick Links and Admin Access -->
    <div class="col-md-7 bg-dark-navy text-white py-4 px-4">
      <div class="default-padding-right">
        <div class="mb-5">
          <div class="mb-5">
            <!-- Quick Links Section -->
            <h2 class="mb-2 font-primary-title">Quick Links</h2>
            <hr class="thick-white-divider mb-3">

            <% quick_links = [
                ["Resources", resources_path],
                ["View Service Hours", services_path],
                ["Google Photos", "#"],
                ["Upcoming Events", events_path],
                ["Member Directory", "#"]
              ] %>

            <div class="row g-3 mb-4">
              <% quick_links.each do |name, path| %>
                <div class="col-12 col-sm-6 col-md-4 col-lg-4">
                  <%= link_to name, path, class: "btn white-btn-member-center font-primary-heading w-100" %>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Admin Access Section (Exec/President Only) -->
          <% if @user.exec? || @user.president? %>
            <h2 class="mb-2 font-primary-title">Admin Access</h2>
            <hr class="thick-white-divider mb-3">

            <% admin_links = [
                ["Events Dashboard", dashboard_events_path],
                ["Resources Dashboard", dashboard_resources_path],
                ["Service Dashboard", services_dashboard_path],
                ["Members Dashboard", users_path],
                ["Committees Dashboard", dashboard_committees_path],
                ["Edit Home Page", edit_home_path],
                ["Edit About Us Page", edit_about_path],
                ["Edit Recruitment Page", edit_recruitment_path],
                ["Edit Contact Us Page", edit_contact_path],
                ["Admin User Guide", "#"]
              ] %>

            <div class="row g-3">
              <% admin_links.each do |name, path| %>
                <div class="col-12 col-sm-6 col-md-4 col-lg-4">
                  <%= link_to name, path,
                      class: "btn white-btn-member-center font-primary-heading w-100",
                      data: (name == "Admin User Guide" ? { bs_toggle: "modal", bs_target: "#pageManagementModal" } : {}) %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
  </div>
</div>


<!--  Pop-up Modals -->
<!-- Manage Gallery & Caption Modal -->
<div class="modal fade edit-info-modal" id="manageGalleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark-navy text-white default-border-radius">

      <!-- Modal Header with bottom border -->
      <div class="modal-header" style="border-bottom: 1px solid white;">
        <h5 class="modal-title font-primary-heading">Manage Photo Gallery & Caption</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">

        <!-- Upload New Photos Section -->
        <%= form_with url: upload_gallery_path, method: :post, local: true, html: { multipart: true } do |f| %>
          <div class="mb-3">
            <label class="form-label font-primary-heading">Upload New Photos</label>
            <%= f.file_field :gallery_photos, multiple: true, class: "form-control bg-dark-navy text-white default-border-radius" %>
          </div>

          <div class="text-end mt-3">
            <%= f.submit "Upload Photos", class: "btn btn-gold text-dark-navy font-secondary-body" %>
          </div>
        <% end %>

        <!-- Divider -->
        <div class="w-100 mx-0 my-4" style="border-top: 1px solid white;"></div>


        <!-- Current Uploaded Photos with Delete Option -->
        <div class="current-photos mt-4">
          <h6 class="font-primary-heading mb-3">Current Uploaded Photos</h6>
          <ul class="list-group list-group-flush">
            <% @shared_user.gallery_photos.each do |photo| %>
              <li class="list-group-item bg-dark-navy text-white d-flex justify-content-between align-items-center mb-2" style="border: 1px solid white;">
                <!-- Thumbnail + filename -->
                <div class="d-flex align-items-center gap-3">
                  <%= image_tag(photo.variant(resize_to_limit: [120, 120]).processed, class: "img-thumbnail me-2", alt: "Thumbnail") %>
                  <span class="font-secondary-subheading"><%= photo.filename.to_s %></span>
                </div>

                <!-- Delete button -->
                <%= button_to "Delete",
                    delete_gallery_photo_path(photo_id: photo.id),
                    method: :delete,
                    data: { confirm: "Are you sure you want to delete this photo?" },
                    class: "btn btn-sm btn-gold text-dark-navy font-secondary-body" %>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Divider -->
        <div class="w-100 mx-0 my-4" style="border-top: 1px solid white;"></div>


        <!-- Edit Gallery Caption Section -->
        <%= form_with url: update_member_center_caption_path, method: :post, local: true do |f| %>
          <div class="mb-3 form-dark-navy">
            <label class="form-label font-primary-heading">Edit Gallery Caption (HTML allowed)</label>
            <%= f.text_area :text,
                value: member_center_caption_text,
                class: "form-control bg-dark-navy text-white default-border-radius",
                rows: 3 %>
          </div>

          <div class="text-end">
            <%= f.submit "Save Caption", class: "btn btn-gold text-dark-navy font-secondary-body" %>
          </div>
        <% end %>

      </div>

      <!-- Optional Modal Footer -->
      <div class="modal-footer" style="border-top: 1px solid white;">
        <button type="button" class="btn btn-gold text-dark-navy font-secondary-body" data-bs-dismiss="modal">
          Close
        </button>
      </div>

    </div>
  </div>
</div>


<!-- Page Management Modal -->
<div class="modal fade" id="pageManagementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark-navy text-white default-border-radius" style="border: 1px solid white;">
      
      <!-- Modal Header -->
      <div class="modal-header" style="border-bottom: 1px solid white;">
        <h5 class="modal-title">Admin User Guide</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body font-secondary-subheading">
        <p>Welcome to the User Guide. As an Admin, you have access to the following features:</p>
        <ul>
          <li>Editing public-facing views</li>
          <li>Updating member data and processing requests</li>
          <li>Managing resources, events, and other Member Center features</li>
        </ul>

        <h6 class="font-secondary-body text-gold mt-4">Navigating the Member Center</h6>
        <ul class="font-secondary-subheading">
          <li>The left sidebar allows you to modify the photo gallery and associated caption by adding/removing photos and editing the caption.</li>
          <li>The <strong>Add Announcement</strong> button allows you to create an announcement that will be displayed on the home page and member center for all users to see.</li>
          <li>Announcements can then be unpublished at any time by clicking the <strong>End Announcement</strong> button. If no announcement is present, the button will be hidden.</li>
        </ul>

        <p>For additional guidance on how to use the Member Center, please refer to the User Guide below.</p>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer" style="border-top: 1px solid white;">
        <% if Announcement.current.message.present? %>
          <!-- End Announcement button -->
          <%= button_to "End Announcement",
                        end_announcement_path,
                        method: :delete,
                        class: "btn btn-gold text-dark-navy font-secondary-body",
                        data: { turbo_confirm: "Are you sure you want to end the announcement?" } %>
        <% else %>
          <!-- Add Announcement button -->
          <button type="button"
                  class="btn btn-gold text-dark-navy font-secondary-body"
                  data-bs-toggle="modal"
                  data-bs-target="#announcementModal">
            Add Announcement
          </button>
        <% end %>

        <!-- Existing buttons -->
        <a href="/Files/Legion_Website_Help_Guide_V.2.pdf"
          target="_blank"
          class="btn btn-gold font-secondary-body">
          Open User Guide (PDF)
        </a>
        <button type="button"
                class="btn btn-gold text-dark-navy font-secondary-body"
                data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div> 
  </div> 
</div>

<!-- Announcement Modal -->
<div class="modal fade" id="announcementModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark-navy text-white default-border-radius" style="border: 1px solid white;">
      <div class="modal-header" style="border-bottom: 1px solid white;">
        <h5 class="modal-title">Add Announcement</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: Announcement.current, url: announcements_path, method: :post, local: true do |f| %>
          <div class="mb-3">
            <%= f.label :message, "Announcement Message (appears on Home & Member Center)", class: "form-label font-secondary-heading" %>
            <%= f.text_area :message, class: "form-control form-dark", rows: 3 %>
          </div>
          <%= f.submit "Publish", class: "btn btn-gold text-dark-navy font-secondary-body" %>
        <% end %>
      </div>
    </div>
  </div>
</div>